generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "mysql"
}

/// 租户表
model Tenant {
  /// 租户ID
  id        Int      @id @default(autoincrement())
  /// 租户名称
  name      String   @db.VarChar(191)
  /// 租户编码
  code      String   @db.VarChar(191)
  /// 是否启用
  isActive  Boolean  @default(true) @map("is_active")
  /// 过期时间
  expiresAt DateTime? @db.Timestamp(3) @map("expires_at")
  /// 创建时间
  createdAt DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy Int? @map("created_by")
  /// 更新人
  updatedBy Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy Int? @map("deleted_by")

  /// 租户用户
  users      User[]
  /// 部门
  departments Department[]
  /// 岗位
  positions  Position[]
  /// 角色
  roles      Role[]
  /// 权限
  permissions Permission[]
  /// 菜单
  menus      Menu[]
  /// 字典组
  dictionaryGroups DictionaryGroup[]
  /// 通知模板
  noticeTemplates NoticeTemplate[]
  /// 通知
  notices    Notice[]
  /// 工单流程
  ticketFlows TicketFlow[]
  /// 工单
  tickets    Ticket[]

  @@unique([code, deletedAt])
  @@unique([name, deletedAt])
  @@map("tenant")
}

/// 部门表
model Department {
  /// 部门ID
  id        Int      @id @default(autoincrement())
  /// 租户ID
  tenantId  Int @map("tenant_id")
  /// 部门名称
  name      String
  /// 部门编码
  code      String?
  /// 排序
  order     Int      @default(0)
  /// 是否启用
  isActive  Boolean  @default(true) @map("is_active")
  /// 父级部门ID
  parentId  Int? @map("parent_id")
  /// 创建时间
  createdAt DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy Int? @map("created_by")
  /// 更新人
  updatedBy Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy Int? @map("deleted_by")

  /// 租户
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  /// 父部门
  parent   Department? @relation("DepartmentToParent", fields: [parentId], references: [id])
  /// 子部门
  children Department[] @relation("DepartmentToParent")
  /// 用户
  users    User[]

  @@unique([tenantId, code, deletedAt])
  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@index([parentId])
  @@map("department")
}

/// 岗位表
model Position {
  /// 岗位ID
  id        Int      @id @default(autoincrement())
  /// 租户ID
  tenantId  Int @map("tenant_id")
  /// 岗位名称
  name      String
  /// 岗位编码
  code      String?
  /// 岗位描述
  description String?
  /// 是否启用
  isActive  Boolean  @default(true) @map("is_active")
  /// 创建时间
  createdAt DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy Int? @map("created_by")
  /// 更新人
  updatedBy Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy Int? @map("deleted_by")

  /// 租户
  tenant Tenant @relation(fields: [tenantId], references: [id])
  /// 用户岗位关联
  users UserPosition[]

  @@unique([tenantId, code, deletedAt])
  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@map("position")
}

/// 用户岗位关联表
model UserPosition {
  /// 关联ID
  id         Int      @id @default(autoincrement())
  /// 租户ID
  tenantId   Int @map("tenant_id")
  /// 用户ID
  userId     Int @map("user_id")
  /// 岗位ID
  positionId Int @map("position_id")
  /// 创建时间
  createdAt  DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 创建人
  createdBy  Int? @map("created_by")

  /// 用户
  user     User @relation(fields: [userId], references: [id])
  /// 岗位
  position Position @relation(fields: [positionId], references: [id])

  @@unique([tenantId, userId, positionId])
  @@index([tenantId])
  @@index([userId])
  @@index([positionId])
  @@map("user_position")
}

/// 用户表
model User {
  /// 用户ID
  id              Int      @id @default(autoincrement())
  /// 租户ID
  tenantId        Int @map("tenant_id")
  /// 用户名
  username        String   @db.VarChar(191)
  /// 邮箱
  email           String?
  /// 密码哈希
  passwordHash    String @map("password_hash")
  /// 显示名称
  displayName     String? @map("display_name")
  /// 头像文件ID
  avatarFileId    Int? @map("avatar_file_id")
  /// 部门ID
  departmentId    Int? @map("department_id")
  /// 是否启用
  isActive        Boolean  @default(true) @map("is_active")
  /// 最后登录时间
  lastLoginAt     DateTime? @db.Timestamp(3) @map("last_login_at")
  /// 创建时间
  createdAt       DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt       DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy       Int? @map("created_by")
  /// 更新人
  updatedBy       Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt       DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy       Int? @map("deleted_by")

  /// 租户
  tenant          Tenant @relation(fields: [tenantId], references: [id])
  /// 部门
  department      Department? @relation(fields: [departmentId], references: [id])
  /// 用户岗位
  positions       UserPosition[]
  /// 用户角色关联
  roles           UserRole[]
  /// 登录会话
  sessions        Session[]
  /// 操作日志
  operationLogs   OperationLog[]
  /// 终端会话
  terminalSessions TerminalSession[]
  /// 头像文件
  avatarFile      FileAsset? @relation(fields: [avatarFileId], references: [id])

  @@unique([tenantId, username, deletedAt])
  @@unique([tenantId, email, deletedAt])
  @@index([tenantId])
  @@index([departmentId])
  @@map("user")
}

/// 角色表
model Role {
  /// 角色ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 角色名称
  name        String
  /// 角色编码
  code        String
  /// 角色描述
  description String?
  /// 数据范围类型
  dataScopeType String @default("ALL") @map("data_scope_type")
  /// 自定义数据范围(部门ID列表)
  dataScopeDepartmentIds Json? @map("data_scope_department_ids")
  /// 是否启用
  isActive    Boolean  @default(true) @map("is_active")
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  /// 租户
  tenant      Tenant @relation(fields: [tenantId], references: [id])
  /// 用户角色关联
  users       UserRole[]
  /// 角色权限关联
  permissions RolePermission[]

  @@unique([tenantId, code, deletedAt])
  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@map("role")
}

/// 权限表
model Permission {
  /// 权限ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 权限名称
  name        String
  /// 权限编码
  code        String
  /// 权限描述
  description String?
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  /// 租户
  tenant Tenant @relation(fields: [tenantId], references: [id])
  /// 角色权限关联
  roles RolePermission[]
  /// 菜单关联
  menus Menu[]

  @@unique([tenantId, code, deletedAt])
  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@map("permission")
}

/// 用户-角色关联表
model UserRole {
  /// 关联ID
  id        Int      @id @default(autoincrement())
  /// 租户ID
  tenantId  Int @map("tenant_id")
  /// 用户ID
  userId    Int @map("user_id")
  /// 角色ID
  roleId    Int @map("role_id")
  /// 创建时间
  createdAt DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 创建人
  createdBy Int? @map("created_by")

  /// 用户
  user User @relation(fields: [userId], references: [id])
  /// 角色
  role Role @relation(fields: [roleId], references: [id])

  @@unique([tenantId, userId, roleId])
  @@index([tenantId])
  @@map("user_role")
}

/// 角色-权限关联表
model RolePermission {
  /// 关联ID
  id           Int      @id @default(autoincrement())
  /// 租户ID
  tenantId     Int @map("tenant_id")
  /// 角色ID
  roleId       Int @map("role_id")
  /// 权限ID
  permissionId Int @map("permission_id")
  /// 创建时间
  createdAt    DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 创建人
  createdBy    Int? @map("created_by")

  /// 角色
  role       Role       @relation(fields: [roleId], references: [id])
  /// 权限
  permission Permission @relation(fields: [permissionId], references: [id])

  @@unique([tenantId, roleId, permissionId])
  @@index([tenantId])
  @@map("role_permission")
}

/// 菜单表
model Menu {
  /// 菜单ID
  id           Int      @id @default(autoincrement())
  /// 租户ID
  tenantId     Int @map("tenant_id")
  /// 菜单名称
  name         String
  /// 路由路径
  path         String
  /// 前端组件
  component    String
  /// 菜单图标
  icon         String?
  /// 排序
  order        Int      @default(0)
  /// 是否隐藏
  isHidden     Boolean  @default(false) @map("is_hidden")
  /// 是否启用
  isActive     Boolean  @default(true) @map("is_active")
  /// 是否目录
  isDirectory  Boolean  @default(false) @map("is_directory")
  /// 父级菜单ID
  parentId     Int? @map("parent_id")
  /// 权限ID
  permissionId Int? @map("permission_id")
  /// 创建时间
  createdAt    DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt    DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy    Int? @map("created_by")
  /// 更新人
  updatedBy    Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt    DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy    Int? @map("deleted_by")

  /// 租户
  tenant      Tenant      @relation(fields: [tenantId], references: [id])
  /// 父菜单
  parent      Menu?       @relation("MenuToParent", fields: [parentId], references: [id])
  /// 子菜单
  children    Menu[]      @relation("MenuToParent")
  /// 权限
  permission  Permission? @relation(fields: [permissionId], references: [id])

  @@unique([tenantId, path, deletedAt])
  @@index([tenantId])
  @@index([parentId])
  @@index([permissionId])
  @@map("menu")
}

/// 文件表
model FileAsset {
  /// 文件ID
  id           Int      @id @default(autoincrement())
  /// 租户ID
  tenantId     Int @map("tenant_id")
  /// 存储类型(local/oss)
  storageType  String @map("storage_type")
  /// 原始文件名
  originalName String @map("original_name")
  /// 文件类型
  mimeType     String @map("mime_type")
  /// 文件哈希
  hash         String
  /// 文件路径
  path         String
  /// 文件大小(字节)
  size         Int
  /// 创建时间
  createdAt    DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt    DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy    Int? @map("created_by")
  /// 更新人
  updatedBy    Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt    DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy    Int? @map("deleted_by")

  /// 关联用户(头像)
  users User[]

  @@unique([tenantId, hash, deletedAt])
  @@index([tenantId])
  @@map("file_asset")
}

/// 系统配置表
model SystemConfig {
  /// 配置ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 配置键
  key         String
  /// 配置值
  value       Json
  /// 配置说明
  description String?
  /// 是否前端可见
  isPublic    Boolean  @default(false) @map("is_public")
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  @@unique([tenantId, key, deletedAt])
  @@index([tenantId])
  @@map("system_config")
}

/// 登录会话表(Refresh Token)
model Session {
  /// 会话ID
  id               Int       @id @default(autoincrement())
  /// 租户ID
  tenantId         Int @map("tenant_id")
  /// 用户ID
  userId           Int @map("user_id")
  /// Refresh Token 哈希
  refreshTokenHash String? @map("refresh_token_hash")
  /// 设备ID
  deviceId         String? @map("device_id")
  /// IP
  ip               String?
  /// User-Agent
  userAgent        String? @map("user_agent")
  /// 签发时间
  issuedAt         DateTime @db.Timestamp(3)  @default(now()) @map("issued_at")
  /// 过期时间
  expiresAt        DateTime @db.Timestamp(3) @map("expires_at")
  /// 撤销时间
  revokedAt        DateTime? @db.Timestamp(3) @map("revoked_at")
  /// 创建时间
  createdAt        DateTime @db.Timestamp(3)  @default(now()) @map("created_at")

  /// 用户
  user User @relation(fields: [userId], references: [id])
  @@index([tenantId])
  @@index([userId])
  @@map("session")
}

/// 终端会话表
model TerminalSession {
  /// 记录ID
  id        Int      @id @default(autoincrement())
  /// 租户ID
  tenantId  Int @map("tenant_id")
  /// 用户ID
  userId    Int @map("user_id")
  /// 会话名称
  name      String?
  /// 终端会话ID
  sessionId String   @map("session_id")
  /// 是否激活
  isActive  Boolean  @default(true) @map("is_active")
  /// 最后活跃时间
  lastActiveAt DateTime? @db.Timestamp(3) @map("last_active_at")
  /// 创建时间
  createdAt DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy Int? @map("created_by")
  /// 更新人
  updatedBy Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy Int? @map("deleted_by")

  /// 用户
  user User @relation(fields: [userId], references: [id])

  @@unique([tenantId, sessionId, deletedAt])
  @@index([tenantId])
  @@index([userId])
  @@map("terminal_session")
}

/// 操作日志表
model OperationLog {
  /// 日志ID
  id         Int      @id @default(autoincrement())
  /// 租户ID
  tenantId   Int @map("tenant_id")
  /// 用户ID
  userId     Int? @map("user_id")
  /// 操作名称
  action     String
  /// 目标类型
  targetType String? @map("target_type")
  /// 目标ID
  targetId   String? @map("target_id")
  /// 操作内容
  payload    Json?
  /// IP
  ip         String?
  /// User-Agent
  userAgent  String? @map("user_agent")
  /// 创建时间
  createdAt  DateTime @db.Timestamp(3) @default(now()) @map("created_at")

  /// 用户
  user User? @relation(fields: [userId], references: [id])
  @@index([tenantId])
  @@index([userId])
  @@map("operation_log")
}

/// 字典组表
model DictionaryGroup {
  /// 字典组ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 字典组名称
  name        String
  /// 字典组编码
  code        String
  /// 字典组描述
  description String?
  /// 排序
  order       Int      @default(0)
  /// 是否启用
  isActive    Boolean  @default(true) @map("is_active")
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  /// 租户
  tenant Tenant @relation(fields: [tenantId], references: [id])
  /// 字典项
  items  DictionaryItem[]

  @@unique([tenantId, code, deletedAt])
  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@map("dictionary_group")
}

/// 字典项表
model DictionaryItem {
  /// 字典项ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 字典组ID
  groupId     Int @map("group_id")
  /// 字典项名称
  label       String
  /// 字典项值
  value       String
  /// 排序
  order       Int      @default(0)
  /// 是否启用
  isActive    Boolean  @default(true) @map("is_active")
  /// 字典项描述
  description String?
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  /// 字典组
  group DictionaryGroup @relation(fields: [groupId], references: [id])

  @@unique([tenantId, groupId, value, deletedAt])
  @@index([tenantId])
  @@index([groupId])
  @@map("dictionary_item")
}

/// 通知模板表
model NoticeTemplate {
  /// 模板ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 模板名称
  name        String
  /// 模板编码
  code        String
  /// 模板内容
  content     Json
  /// 模板描述
  description String?
  /// 是否启用
  isActive    Boolean  @default(true) @map("is_active")
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  /// 租户
  tenant Tenant @relation(fields: [tenantId], references: [id])
  /// 通知
  notices Notice[]

  @@unique([tenantId, code, deletedAt])
  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@map("notice_template")
}

/// 通知表
model Notice {
  /// 通知ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 模板ID
  templateId  Int? @map("template_id")
  /// 通知标题
  title       String
  /// 通知内容
  content     Json
  /// 状态
  status      String   @default("DRAFT")
  /// 发布时间
  publishedAt DateTime? @db.Timestamp(3) @map("published_at")
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  /// 模板
  template NoticeTemplate? @relation(fields: [templateId], references: [id])
  /// 租户
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([templateId])
  @@map("notice")
}

/// 工单表
model Ticket {
  /// 工单ID
  id           Int      @id @default(autoincrement())
  /// 租户ID
  tenantId     Int @map("tenant_id")
  /// 工单标题
  title        String
  /// 工单描述
  description  String?
  /// 工单状态
  status       String   @default("OPEN")
  /// 流程ID
  flowId       Int? @map("flow_id")
  /// 当前节点ID
  currentNodeId Int? @map("current_node_id")
  /// 发起人ID
  requesterId  Int? @map("requester_id")
  /// 创建时间
  createdAt    DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt    DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy    Int? @map("created_by")
  /// 更新人
  updatedBy    Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt    DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy    Int? @map("deleted_by")

  /// 租户
  tenant Tenant @relation(fields: [tenantId], references: [id])
  /// 流程
  flow   TicketFlow? @relation(fields: [flowId], references: [id])
  /// 流程实例
  flowInstance TicketFlowInstance?

  @@index([tenantId])
  @@index([flowId])
  @@map("ticket")
}

/// 工单流程表
model TicketFlow {
  /// 流程ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 流程名称
  name        String
  /// 流程描述
  description String?
  /// 是否启用
  isActive    Boolean  @default(true) @map("is_active")
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt   DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy   Int? @map("created_by")
  /// 更新人
  updatedBy   Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt   DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy   Int? @map("deleted_by")

  /// 租户
  tenant Tenant @relation(fields: [tenantId], references: [id])
  /// 流程节点
  nodes TicketFlowNode[]
  /// 流程条件
  conditions TicketFlowCondition[]
  /// 工单
  tickets Ticket[]
  /// 流程实例
  instances TicketFlowInstance[]

  @@unique([tenantId, name, deletedAt])
  @@index([tenantId])
  @@map("ticket_flow")
}

/// 工单流程节点表
model TicketFlowNode {
  /// 节点ID
  id        Int      @id @default(autoincrement())
  /// 租户ID
  tenantId  Int @map("tenant_id")
  /// 流程ID
  flowId    Int @map("flow_id")
  /// 节点名称
  name      String
  /// 节点类型
  type      String
  /// 排序
  order     Int      @default(0)
  /// 是否开始节点
  isStart   Boolean  @default(false) @map("is_start")
  /// 是否结束节点
  isEnd     Boolean  @default(false) @map("is_end")
  /// 创建时间
  createdAt DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 更新时间
  updatedAt DateTime @db.Timestamp(3) @updatedAt @map("updated_at")
  /// 创建人
  createdBy Int? @map("created_by")
  /// 更新人
  updatedBy Int? @map("updated_by")
  /// 删除时间(软删除)
  deletedAt DateTime? @db.Timestamp(3) @map("deleted_at")
  /// 删除人
  deletedBy Int? @map("deleted_by")

  /// 流程
  flow TicketFlow @relation(fields: [flowId], references: [id])
  /// 流程实例
  instances TicketFlowInstance[]

  @@index([tenantId])
  @@index([flowId])
  @@map("ticket_flow_node")
}

/// 工单流程条件表
model TicketFlowCondition {
  /// 条件ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 流程ID
  flowId      Int @map("flow_id")
  /// 来源节点ID
  sourceNodeId Int @map("source_node_id")
  /// 目标节点ID
  targetNodeId Int @map("target_node_id")
  /// 条件表达式
  expression  Json @map("expression")
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 创建人
  createdBy   Int? @map("created_by")

  /// 流程
  flow TicketFlow @relation(fields: [flowId], references: [id])

  @@index([tenantId])
  @@index([flowId])
  @@index([sourceNodeId])
  @@index([targetNodeId])
  @@map("ticket_flow_condition")
}

/// 工单流程实例表
model TicketFlowInstance {
  /// 实例ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 工单ID
  ticketId    Int @unique @map("ticket_id")
  /// 流程ID
  flowId      Int @map("flow_id")
  /// 当前节点ID
  currentNodeId Int? @map("current_node_id")
  /// 状态
  status      String   @default("RUNNING")
  /// 开始时间
  startedAt   DateTime @db.Timestamp(3) @default(now()) @map("started_at")
  /// 结束时间
  endedAt     DateTime? @db.Timestamp(3) @map("ended_at")

  /// 工单
  ticket Ticket @relation(fields: [ticketId], references: [id])
  /// 流程
  flow   TicketFlow @relation(fields: [flowId], references: [id])
  /// 当前节点
  currentNode TicketFlowNode? @relation(fields: [currentNodeId], references: [id])
  /// 历史记录
  histories TicketFlowInstanceHistory[]

  @@index([tenantId])
  @@index([flowId])
  @@map("ticket_flow_instance")
}

/// 工单流程实例历史表
model TicketFlowInstanceHistory {
  /// 历史ID
  id          Int      @id @default(autoincrement())
  /// 租户ID
  tenantId    Int @map("tenant_id")
  /// 实例ID
  instanceId  Int @map("instance_id")
  /// 来源节点ID
  fromNodeId  Int? @map("from_node_id")
  /// 目标节点ID
  toNodeId    Int? @map("to_node_id")
  /// 操作动作
  action      String
  /// 操作内容
  payload     Json?
  /// 创建时间
  createdAt   DateTime @db.Timestamp(3) @default(now()) @map("created_at")
  /// 创建人
  createdBy   Int? @map("created_by")

  /// 实例
  instance TicketFlowInstance @relation(fields: [instanceId], references: [id])

  @@index([tenantId])
  @@index([instanceId])
  @@map("ticket_flow_instance_history")
}
